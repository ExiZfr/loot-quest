<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LootQuest | Admin Panel</title>
    <link rel="icon" href="/favicon.png?v=2" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_relativeTime);</script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        loot: { black: '#050505', dark: '#0a0a0a', card: '#121212', neon: '#00f3ff', purple: '#bc13fe', gold: '#ffd700' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #e0e0e0;
        }

        .glass {
            background: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-link.active {
            background: rgba(188, 19, 254, 0.1);
            color: #bc13fe;
            border-right: 2px solid #bc13fe;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Auth Check Overlay -->
    <div id="auth-check" class="fixed inset-0 z-50 bg-loot-black flex items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-loot-purple border-t-transparent rounded-full"></div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-loot-card border-r border-white/5 flex flex-col">
            <div class="p-6 border-b border-white/5">
                <h1 class="font-display font-bold text-xl tracking-tight text-white">LOOT<span
                        class="text-loot-neon">ADMIN</span></h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchTab('overview')" id="nav-overview"
                    class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium active">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Overview
                </button>
                <button onclick="switchTab('orders')" id="nav-orders"
                    class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> Orders <span id="badge-orders"
                        class="ml-auto bg-loot-neon/10 text-loot-neon text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="switchTab('reports')" id="nav-reports"
                    class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Reports <span id="badge-reports"
                        class="ml-auto bg-red-500/10 text-red-500 text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="switchTab('messages')" id="nav-messages"
                    class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                    <i data-lucide="mail" class="w-5 h-5"></i> Messages <span id="badge-messages"
                        class="ml-auto bg-blue-500/10 text-blue-500 text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
            </nav>
            <div class="p-4 border-t border-white/5">
                <button onclick="window.location.href='/dashboard.html'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Back to Site
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-loot-black relative">

            <!-- OVERVIEW TAB -->
            <div id="tab-overview" class="p-8 space-y-8">
                <h2 class="text-2xl font-bold font-display text-white">Dashboard Overview</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-1">Total Users</div>
                        <div class="text-3xl font-bold text-white" id="stat-users">-</div>
                    </div>
                    <div class="glass p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-1">Points Distributed</div>
                        <div class="text-3xl font-bold text-loot-gold" id="stat-points">-</div>
                    </div>
                    <div class="glass p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-1">Pending Orders</div>
                        <div class="text-3xl font-bold text-loot-neon" id="stat-orders">-</div>
                    </div>
                    <div class="glass p-6 rounded-xl">
                        <div class="text-gray-400 text-sm mb-1">Open Tickets</div>
                        <div class="text-3xl font-bold text-loot-purple" id="stat-tickets">-</div>
                    </div>
                </div>
            </div>

            <!-- ORDERS TAB -->
            <div id="tab-orders" class="p-8 space-y-8 hidden">
                <h2 class="text-2xl font-bold font-display text-white">Gift Card Orders</h2>
                <div class="glass rounded-xl overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-white/5 text-gray-400 text-sm uppercase">
                            <tr>
                                <th class="p-4">User</th>
                                <th class="p-4">Reward</th>
                                <th class="p-4">Cost</th>
                                <th class="p-4">Date</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list" class="divide-y divide-white/5 text-sm">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="tab-reports" class="p-8 space-y-8 hidden">
                <h2 class="text-2xl font-bold font-display text-white">Bug Reports</h2>
                <div id="reports-list" class="space-y-4">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- MESSAGES TAB -->
            <div id="tab-messages" class="p-8 space-y-8 hidden">
                <h2 class="text-2xl font-bold font-display text-white">Contact Messages</h2>
                <div id="messages-list" class="space-y-4">
                    <!-- JS Injected -->
                </div>
            </div>

        </main>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 translate-y-24 transition-transform duration-300">
        <div
            class="bg-loot-card border border-loot-neon text-white px-6 py-4 rounded-xl shadow-neon flex items-center gap-3">
            <i data-lucide="check-circle" class="text-loot-neon"></i>
            <span id="toast-msg">Action completed</span>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let currentUser = null;

        async function init() {
            try {
                // Check Auth & Admin Status
                const res = await fetch('/api/user/me');
                const data = await res.json();

                if (!data.success) {
                    window.location.href = '/?login=admin';
                    return;
                }

                // Temporary check until role property is fully propagated in all endpoints
                // We'll trust the API calls to fail if not admin
                loadStats();
                document.getElementById('auth-check').classList.add('hidden');
            } catch (e) {
                console.error(e);
                window.location.href = '/';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');

            if (tabId === 'orders') loadOrders();
            if (tabId === 'reports') loadReports();
            if (tabId === 'messages') loadMessages();
            if (tabId === 'overview') loadStats();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                if (!data.success) { if (res.status === 403) alert("Access Denied"); return; }

                const s = data.stats;
                document.getElementById('stat-users').innerText = s.users.toLocaleString();
                document.getElementById('stat-points').innerText = s.totalPointsDistributed.toLocaleString();
                document.getElementById('stat-orders').innerText = s.pendingWithdrawals;
                document.getElementById('stat-tickets').innerText = s.openReports + s.unreadMessages;

                if (s.pendingWithdrawals > 0) {
                    const badge = document.getElementById('badge-orders');
                    badge.innerText = s.pendingWithdrawals;
                    badge.classList.remove('hidden');
                }
            } catch (e) { console.error(e); }
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr>';

            try {
                const res = await fetch('/api/admin/orders');
                const data = await res.json();
                if (!data.success) return;

                if (data.orders.length === 0) {
                    list.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No pending orders.</td></tr>';
                    return;
                }

                list.innerHTML = data.orders.map(o => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="p-4">
                            <div class="font-bold text-white">${o.display_name}</div>
                            <div class="text-xs text-gray-500">${o.email}</div>
                        </td>
                        <td class="p-4 text-loot-neon">${o.reward_name}</td>
                        <td class="p-4 text-loot-gold">${o.points_spent.toLocaleString()} PTS</td>
                        <td class="p-4 text-gray-400">${dayjs(o.created_at).fromNow()}</td>
                        <td class="p-4 text-right">
                            <button onclick="processOrder(${o.id}, 'completed')" class="px-3 py-1 bg-green-500/20 text-green-500 rounded hover:bg-green-500/30 text-xs font-bold mr-2">APPROVE</button>
                            <button onclick="processOrder(${o.id}, 'cancelled')" class="px-3 py-1 bg-red-500/20 text-red-500 rounded hover:bg-red-500/30 text-xs font-bold">REJECT</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadReports() {
            const list = document.getElementById('reports-list');
            list.innerHTML = '<div class="text-center text-gray-500">Loading...</div>';

            try {
                const res = await fetch('/api/admin/reports');
                const data = await res.json();

                if (data.reports.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500">No reports found.</div>';
                    return;
                }

                list.innerHTML = data.reports.map(r => `
                    <div class="glass p-6 rounded-xl border-l-4 ${r.status === 'new' ? 'border-red-500' : 'border-green-500'}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-white text-lg">${r.subject}</h3>
                            <span class="text-xs bg-white/10 px-2 py-1 rounded text-gray-400">${dayjs(r.created_at).fromNow()}</span>
                        </div>
                        <p class="text-gray-400 text-sm mb-4 bg-black/30 p-3 rounded font-mono">${r.content}</p>
                        <div class="flex items-center justify-between">
                             <div class="text-xs text-gray-500">USER ID: ${r.user_id || 'Anonymous'}</div>
                             ${r.status === 'new' ?
                        `<button onclick="resolveTicket(${r.id}, 'resolved')" class="text-xs bg-loot-neon/10 text-loot-neon px-3 py-1 rounded hover:bg-loot-neon/20">MARK RESOLVED</button>` :
                        `<span class="text-xs text-green-500 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Resolved</span>`
                    }
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        async function loadMessages() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '<div class="text-center text-gray-500">Loading...</div>';
            try {
                const res = await fetch('/api/admin/messages');
                const data = await res.json();

                if (data.messages.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500">No messages.</div>';
                    return;
                }

                list.innerHTML = data.messages.map(m => `
                   <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-white text-lg">${m.subject}</h3>
                                <div class="text-xs text-blue-400">${m.email}</div>
                            </div>
                            <span class="text-xs bg-white/10 px-2 py-1 rounded text-gray-400">${dayjs(m.created_at).fromNow()}</span>
                        </div>
                        <p class="text-gray-300 text-sm mb-4">${m.content}</p>
                        <div class="flex justify-end">
                            <a href="mailto:${m.email}" class="text-xs bg-white/5 border border-white/10 px-3 py-1 rounded hover:bg-white/10 flex items-center gap-2">
                                <i data-lucide="reply" class="w-3 h-3"></i> Reply via Email
                            </a>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        async function processOrder(id, status) {
            if (!confirm(`Are you sure you want to mark this order as ${status.toUpperCase()}?`)) return;
            try {
                const res = await fetch('/api/admin/process-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status, notes: `Processed by admin` })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`Order ${status}`);
                    loadOrders();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) { alert(e.message); }
        }

        async function resolveTicket(id, status) {
            try {
                const res = await fetch('/api/admin/resolve-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                });
                if (await res.json().then(d => d.success)) {
                    showToast('Ticket updated');
                    loadReports();
                    loadStats();
                }
            } catch (e) { console.error(e); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-24');
            setTimeout(() => t.classList.add('translate-y-24'), 3000);
        }

        init();
    </script>
</body>

</html>