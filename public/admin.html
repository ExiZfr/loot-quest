<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LootQuest | Admin Panel</title>
    <link rel="icon" href="/favicon.png?v=2" type="image/png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif']
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            card: 'rgba(15, 23, 42, 0.6)'
                        },
                        brand: {
                            purple: '#8b5cf6',
                            cyan: '#06b6d4',
                            accent: '#22d3ee'
                        }
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(139, 92, 246, 0.3), 0 0 20px rgba(6, 182, 212, 0.2)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .sidebar-link {
            transition: all 0.2s ease;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
        }

        .stat-icon {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.1);
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="antialiased">

    <!-- Auth Check Overlay -->
    <div id="auth-check" class="fixed inset-0 z-50 bg-dark-900 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-400">V√©rification des permissions...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-64 bg-dark-900/95 backdrop-blur-md border-r border-white/5 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-white/5">
                <h1 class="text-2xl font-bold font-display">
                    LOOT<span class="text-brand-cyan">ADMIN</span>
                </h1>
                <p class="text-xs text-gray-500 mt-1">Fraud Detection v2.8</p>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#live-monitor" onclick="showSection('live-monitor')"
                    class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                    <span>Live Monitor</span>
                </a>
                <a href="#kill-zone" onclick="showSection('kill-zone')"
                    class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i>
                    <span>Kill Zone</span>
                </a>
                <a href="/admin-seo.html"
                    class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span>SEO Analytics</span>
                </a>
            </nav>

            <!-- Footer -->
            <div class="p-4 border-t border-white/5">
                <button onclick="window.location.href='/'"
                    class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-gray-400 hover:bg-white/5 transition">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span class="text-sm">Back to Site</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">

            <!-- Live Monitor Section -->
            <section id="live-monitor" class="p-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Live Monitor</h2>
                    <p class="text-gray-400">Real-time platform health and fraud detection metrics.</p>
                </div>

                <!-- Stat Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

                    <!-- Total Users -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Total Users</p>
                                <h3 class="text-3xl font-bold text-white" id="stat-users">0</h3>
                                <p class="text-xs text-green-400 mt-2">‚Üë +12% vs yesterday</p>
                            </div>
                            <div class="stat-icon p-3 rounded-xl">
                                <i data-lucide="users" class="w-6 h-6 text-brand-purple"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Online Now -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Online Now</p>
                                <h3 class="text-3xl font-bold text-white" id="stat-online">0</h3>
                                <p class="text-xs text-gray-500 mt-2">Last 15 min</p>
                            </div>
                            <div class="stat-icon p-3 rounded-xl">
                                <i data-lucide="radio" class="w-6 h-6 text-brand-cyan"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Requests -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Pending Requests</p>
                                <h3 class="text-3xl font-bold text-white" id="stat-pending">0</h3>
                                <p class="text-xs text-yellow-400 mt-2">Needs review</p>
                            </div>
                            <div class="stat-icon p-3 rounded-xl">
                                <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Revenue -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Daily Revenue</p>
                                <h3 class="text-3xl font-bold text-white" id="stat-revenue">$0.00</h3>
                                <p class="text-xs text-green-400 mt-2">Platform profit (40%)</p>
                            </div>
                            <div class="stat-icon p-3 rounded-xl">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Additional Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <!-- Points Today -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="stat-icon p-4 rounded-xl">
                                <i data-lucide="zap" class="w-8 h-8 text-brand-cyan"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Points Distributed Today</p>
                                <h3 class="text-2xl font-bold text-white" id="stat-points-today">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Total Points -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="stat-icon p-4 rounded-xl">
                                <i data-lucide="trending-up" class="w-8 h-8 text-brand-purple"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Total Points All Time</p>
                                <h3 class="text-2xl font-bold text-white" id="stat-points-total">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Estimated Revenue -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="stat-icon p-4 rounded-xl">
                                <i data-lucide="pie-chart" class="w-8 h-8 text-green-500"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Est. Revenue (All Time)</p>
                                <h3 class="text-2xl font-bold text-white" id="stat-revenue-total">$0.00</h3>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Kill Zone Section -->
            <section id="kill-zone" class="p-8 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">üî¥ Kill Zone</h2>
                    <p class="text-gray-400">Fraud detection and withdrawal inspection.</p>
                </div>

                <!-- Pending Withdrawals Table -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">Pending Withdrawals</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th class="pb-3 text-sm text-gray-400 font-medium">User</th>
                                    <th class="pb-3 text-sm text-gray-400 font-medium">Reward</th>
                                    <th class="pb-3 text-sm text-gray-400 font-medium">Points</th>
                                    <th class="pb-3 text-sm text-gray-400 font-medium">Flags</th>
                                    <th class="pb-3 text-sm text-gray-400 font-medium">Date</th>
                                    <th class="pb-3 text-sm text-gray-400 font-medium">Action</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-tbody">
                                <tr>
                                    <td colspan="6" class="py-8 text-center text-gray-500">
                                        <div class="spinner mx-auto mb-2"></div>
                                        Loading withdrawals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        lucide.createIcons();

        // Section Navigation
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('active');
                }
            });
        }

        // Auth Check & Init
        async function init() {
            try {
                const res = await fetch('/api/user', { credentials: 'include' });

                if (res.status === 401) {
                    window.location.href = '/?login=required';
                    return;
                }

                const data = await res.json();

                if (!data.success || !data.user) {
                    throw new Error('Invalid response');
                }

                if (data.user.role !== 'admin') {
                    document.getElementById('auth-check').innerHTML = `
                        <div class="text-center">
                            <i data-lucide="shield-x" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold text-white mb-2">ACCESS DENIED</h2>
                            <p class="text-gray-400">Admin privileges required</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Hide auth overlay
                document.getElementById('auth-check').classList.add('hidden');

                // Load data
                await loadStats();
                loadWithdrawals();

                // Auto-refresh every 5 seconds
                setInterval(loadStats, 5000);
                setInterval(loadWithdrawals, 10000);

            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('auth-check').innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 text-2xl font-bold">ERROR</p>
                        <p class="text-gray-400 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats', { credentials: 'include' });
                const { stats } = await res.json();

                document.getElementById('stat-users').textContent = (stats.users || 0).toLocaleString();
                document.getElementById('stat-online').textContent = (stats.onlineUsers || 0).toLocaleString();
                document.getElementById('stat-pending').textContent = (stats.pendingWithdrawals || 0).toLocaleString();
                document.getElementById('stat-revenue').textContent = `$${(stats.dailyRevenue || 0).toFixed(2)}`;
                document.getElementById('stat-points-today').textContent = (stats.dailyPointsDistributed || 0).toLocaleString();
                document.getElementById('stat-points-total').textContent = (stats.totalPointsDistributed || 0).toLocaleString();
                document.getElementById('stat-revenue-total').textContent = `$${(stats.estimatedRevenue || 0).toFixed(2)}`;

            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        // Load Withdrawals
        async function loadWithdrawals() {
            try {
                const res = await fetch('/api/admin/withdrawals/pending', { credentials: 'include' });
                const { withdrawals } = await res.json();

                const tbody = document.getElementById('withdrawals-tbody');

                if (!withdrawals || withdrawals.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-8 text-center text-gray-500">
                                <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-green-500"></i>
                                <p>No pending withdrawals</p>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    return;
                }

                tbody.innerHTML = withdrawals.map(w => `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-4">
                            <div class="text-sm text-white">${w.email}</div>
                            <div class="text-xs text-gray-500">${w.user_id.substring(0, 8)}...</div>
                        </td>
                        <td class="py-4 text-sm text-gray-300">${w.reward_name}</td>
                        <td class="py-4 text-sm font-mono text-brand-cyan">${w.points_spent.toLocaleString()}</td>
                        <td class="py-4">
                            <div class="flex gap-1">
                                ${(w.security?.flags || []).map(flag => `
                                    <span class="px-2 py-1 text-xs rounded-full ${flag === 'NEW_ACCOUNT' ? 'bg-yellow-500/20 text-yellow-400' :
                        flag === 'HIGH_VALUE' ? 'bg-red-500/20 text-red-400' :
                            flag === 'IP_CHANGE' ? 'bg-orange-500/20 text-orange-400' :
                                'bg-gray-500/20 text-gray-400'
                    }">
                                        ${flag}
                                    </span>
                                `).join('')}
                            </div>
                        </td>
                        <td class="py-4 text-sm text-gray-400">${dayjs(w.request_date).fromNow()}</td>
                        <td class="py-4">
                            <button onclick="approveWithdrawal('${w.id}')" class="px-3 py-1 text-xs rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 mr-2">
                                Approve
                            </button>
                            <button onclick="rejectWithdrawal('${w.id}')" class="px-3 py-1 text-xs rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                Reject
                            </button>
                        </td>
                    </tr>
                `).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('Load withdrawals error:', error);
            }
        }

        // Approve Withdrawal
        async function approveWithdrawal(id) {
            if (!confirm('Approve this withdrawal?')) return;

            try {
                const res = await fetch(`/api/admin/withdrawals/${id}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'approve', reason: 'Approved by admin' })
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Withdrawal approved!');
                    loadWithdrawals();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Reject Withdrawal
        async function rejectWithdrawal(id) {
            const reason = prompt('Rejection reason:');
            if (!reason) return;

            try {
                const res = await fetch(`/api/admin/withdrawals/${id}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'reject', reason })
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Withdrawal rejected and refunded!');
                    loadWithdrawals();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>

</body>

</html>