<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LootQuest | Admin Panel</title>
    <link rel="icon" href="/favicon.png?v=2" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        loot: { black: '#050505', card: '#121212', purple: '#8b5cf6', neon: '#06b6d4', gold: '#fbbf24', danger: '#ef4444' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
    <style>
        body {
            background-color: #050505;
            color: #e0e0e0;
        }

        .glass {
            background: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-link {
            transition: all 0.2s ease;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-gray-300 antialiased">

    <!-- Auth Overlay -->
    <div id="auth-check" class="fixed inset-0 z-50 bg-loot-black flex items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-loot-purple border-t-transparent rounded-full"></div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 glass border-r border-white/5 flex flex-col">
        <div class="p-6 border-b border-white/5">
            <h1 class="font-display font-bold text-xl text-white">LOOT<span class="text-loot-neon">ADMIN</span></h1>
            <div class="text-xs text-gray-500 mt-1">Fraud Detection v2.0</div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('overview')" id="nav-overview"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium active">
                <i data-lucide="activity" class="w-5 h-5"></i> Live Monitor
            </button>
            <a href="/admin-seo.html"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i> SEO 3D
            </a>
            <button onclick="switchTab('killzone')" id="nav-killzone"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium">
                <i data-lucide="skull" class="w-5 h-5"></i> Kill Zone
                <span id="badge-killzone"
                    class="ml-auto bg-red-500/20 text-red-500 text-xs px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="switchTab('orders')" id="nav-orders"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i> Orders
            </button>
            <button onclick="switchTab('reports')" id="nav-reports"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i> Reports
            </button>
            <button onclick="switchTab('messages')" id="nav-messages"
                class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 text-sm font-medium">
                <i data-lucide="mail" class="w-5 h-5"></i> Messages
            </button>
        </nav>
        <div class="p-4 border-t border-white/5">
            <a href="/"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white text-sm">
                <i data-lucide="log-out" class="w-5 h-5"></i> Back to Site
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8">
        <!-- LIVE MONITOR TAB -->
        <div id="tab-overview" class="space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                    <span class="relative flex h-3 w-3"><span
                            class="animate-ping absolute h-full w-full rounded-full bg-red-400 opacity-75"></span><span
                            class="relative rounded-full h-3 w-3 bg-red-500"></span></span>
                    Live Monitor
                </h2>
                <button onclick="loadStats()" class="px-4 py-2 bg-white/5 rounded-lg text-sm hover:bg-white/10"><i
                        data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>Sync</button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass p-6 rounded-xl border-l-4 border-loot-purple">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-2">Total Users</div>
                    <div class="text-3xl font-bold text-white" id="stat-users">...</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-loot-neon">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-2">Online Now</div>
                    <div class="text-3xl font-bold text-loot-neon" id="stat-online">...</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-loot-danger">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-2">Pending Requests</div>
                    <div class="text-3xl font-bold text-loot-danger" id="stat-pending">...</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-loot-gold">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-2">Daily Revenue</div>
                    <div class="text-3xl font-bold text-loot-gold" id="stat-revenue">$...</div>
                </div>
            </div>

            <!-- Extended Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-6 rounded-xl">
                    <div class="text-gray-400 text-sm mb-2">Points Distributed Today</div>
                    <div class="text-2xl font-bold text-loot-neon" id="stat-daily-points">...</div>
                </div>
                <div class="glass p-6 rounded-xl">
                    <div class="text-gray-400 text-sm mb-2">Total Points All Time</div>
                    <div class="text-2xl font-bold text-white" id="stat-total-points">...</div>
                </div>
                <div class="glass p-6 rounded-xl">
                    <div class="text-gray-400 text-sm mb-2">Open Tickets</div>
                    <div class="text-2xl font-bold text-loot-purple" id="stat-tickets">...</div>
                </div>
            </div>
        </div>

        <!-- KILL ZONE TAB -->
        <div id="tab-killzone" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="skull"
                    class="text-red-500"></i> The Kill Zone</h2>
            <div class="glass rounded-xl overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                        <tr>
                            <th class="p-4">User</th>
                            <th class="p-4">Reward</th>
                            <th class="p-4">Risk</th>
                            <th class="p-4">Time</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-list" class="divide-y divide-white/5 text-sm"></tbody>
                </table>
                <div id="empty-state" class="hidden text-center py-16 text-gray-500"><i data-lucide="shield-check"
                        class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p>No pending threats.</p>
                </div>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tab-orders" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6">Orders</h2>
            <div id="orders-list" class="glass rounded-xl p-6 text-gray-500">Loading...</div>
        </div>

        <!-- REPORTS TAB -->
        <div id="tab-reports" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6">Reports</h2>
            <div id="reports-list" class="space-y-4 text-gray-500">Loading...</div>
        </div>

        <!-- MESSAGES TAB -->
        <div id="tab-messages" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6">Messages</h2>
            <div id="messages-list" class="space-y-4 text-gray-500">Loading...</div>
        </div>
    </main>

    <!-- Inspection Modal -->
    <div id="inspection-modal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="glass w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl border border-white/10">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white" id="modal-username">User</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black/40 p-3 rounded-lg"><span class="text-xs text-gray-500">IP</span>
                        <div class="text-white font-mono" id="modal-ip">...</div>
                    </div>
                    <div class="bg-black/40 p-3 rounded-lg"><span class="text-xs text-gray-500">Age</span>
                        <div class="text-white" id="modal-age">...</div>
                    </div>
                    <div class="bg-black/40 p-3 rounded-lg"><span class="text-xs text-gray-500">Earned</span>
                        <div class="text-loot-gold font-bold" id="modal-earned">...</div>
                    </div>
                    <div class="bg-black/40 p-3 rounded-lg"><span class="text-xs text-gray-500">Request</span>
                        <div class="text-white" id="modal-request">...</div>
                    </div>
                </div>
                <div class="flex gap-4 pt-4 border-t border-white/5">
                    <button id="btn-reject"
                        class="flex-1 py-3 bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white rounded-xl font-bold transition">REJECT</button>
                    <button id="btn-approve"
                        class="flex-1 py-3 bg-loot-neon text-black hover:bg-white rounded-xl font-bold transition">APPROVE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-6 right-6 bg-white text-black px-6 py-4 rounded-xl shadow-2xl transform translate-y-24 transition-transform z-50">
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        lucide.createIcons();
        let currentWithdrawal = null;

        // Tab Switching
        function switchTab(tabId) {
            ['overview', 'killzone', 'orders', 'reports', 'messages'].forEach(id => {
                document.getElementById('tab-' + id).classList.add('hidden');
                const btn = document.getElementById('nav-' + id);
                if (btn) btn.classList.remove('active');
            });
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            const activeBtn = document.getElementById('nav-' + tabId);
            if (activeBtn) activeBtn.classList.add('active');

            if (tabId === 'overview') loadStats();
            if (tabId === 'killzone') loadKillZone();
            if (tabId === 'orders') loadOrders();
            if (tabId === 'reports') loadReports();
            if (tabId === 'messages') loadMessages();
        }

        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                document.getElementById('stat-users').innerText = data.totalUsers?.toLocaleString() || '0';
                document.getElementById('stat-online').innerText = data.onlineUsers || '0';
                document.getElementById('stat-pending').innerText = data.pendingWithdrawals || '0';
                document.getElementById('stat-revenue').innerText = '$' + (data.dailyRevenue || '0.00');
                document.getElementById('stat-daily-points').innerText = (data.dailyPoints || 0).toLocaleString();
                document.getElementById('stat-total-points').innerText = (data.totalPoints || 0).toLocaleString();
                document.getElementById('stat-tickets').innerText = data.openTickets || '0';

                // Update badge
                const badge = document.getElementById('badge-killzone');
                if (data.pendingWithdrawals > 0) { badge.innerText = data.pendingWithdrawals; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); }
            } catch (e) { console.error('Stats error:', e); }
        }

        // Load Kill Zone
        async function loadKillZone() {
            const list = document.getElementById('withdrawals-list');
            list.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">Loading...</td></tr>';
            try {
                const res = await fetch('/api/admin/withdrawals/pending');
                const data = await res.json();
                if (!data || data.length === 0) {
                    list.innerHTML = '';
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');
                list.innerHTML = data.map(w => `
                    <tr class="hover:bg-white/5">
                        <td class="p-4"><div class="font-bold text-white">${w.user_name || 'Unknown'}</div><div class="text-xs text-gray-500">${w.user_email || ''}</div></td>
                        <td class="p-4 text-loot-purple">${w.amount || 0} PTS</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs ${w.risk_score > 50 ? 'bg-red-500/20 text-red-500' : 'bg-green-500/20 text-green-500'}">${w.risk_score || 0}%</span></td>
                        <td class="p-4 text-gray-400 text-xs">${dayjs(w.created_at).fromNow()}</td>
                        <td class="p-4 text-right"><button onclick='inspect(${JSON.stringify(w).replace(/'/g, "&#39;")})' class="px-3 py-1 bg-white/10 rounded text-xs hover:bg-white/20">INSPECT</button></td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function inspect(w) {
            currentWithdrawal = w;
            document.getElementById('inspection-modal').classList.remove('hidden');
            document.getElementById('modal-username').innerText = w.user_name || 'User';
            document.getElementById('modal-ip').innerText = w.ip_address || 'N/A';
            document.getElementById('modal-age').innerText = w.user_joined_at ? dayjs(w.user_joined_at).fromNow(true) : 'N/A';
            document.getElementById('modal-earned').innerText = (w.total_earned || 0).toLocaleString() + ' PTS';
            document.getElementById('modal-request').innerText = (w.amount || 0) + ' PTS';
            document.getElementById('btn-approve').onclick = () => handleAction('approve');
            document.getElementById('btn-reject').onclick = () => handleAction('reject');
        }

        function closeModal() { document.getElementById('inspection-modal').classList.add('hidden'); }

        async function handleAction(action) {
            if (!confirm(action.toUpperCase() + ' this withdrawal?')) return;
            try {
                const res = await fetch(`/api/admin/withdrawals/${currentWithdrawal.id}/action`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, notes: 'Admin action' })
                });
                const data = await res.json();
                if (data.success) { showToast('Success'); closeModal(); loadKillZone(); loadStats(); }
                else { alert(data.error); }
            } catch (e) { alert(e.message); }
        }

        async function loadOrders() { document.getElementById('orders-list').innerText = 'No pending orders.'; }
        async function loadReports() { document.getElementById('reports-list').innerText = 'No reports.'; }
        async function loadMessages() { document.getElementById('messages-list').innerText = 'No messages.'; }

        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast').classList.remove('translate-y-24');
            setTimeout(() => document.getElementById('toast').classList.add('translate-y-24'), 3000);
        }

        // Init with Auth Check
        async function init() {
            const overlay = document.getElementById('auth-check');
            try {
                const res = await fetch('/api/user');
                if (!res.ok) { window.location.href = '/login.html'; return; }
                const data = await res.json();
                if (!data.user || data.user.role !== 'admin') {
                    overlay.innerHTML = '<div class="text-red-500 text-center"><p class="text-xl font-bold">ACCESS DENIED</p><p class="text-sm mt-2">Admin required.</p></div>';
                    return;
                }
                overlay.style.display = 'none';
                loadStats();
                setInterval(loadStats, 30000);
            } catch (e) {
                overlay.innerHTML = '<div class="text-red-500 text-center"><p class="text-xl font-bold">ERROR</p></div>';
            }
        }
        window.addEventListener('load', init);
    </script>
</body>

</html>